name: Bad CI/CD - What Could Go Wrong?

# –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #1: –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ –≤—Å—ë –ø–æ–¥—Ä—è–¥
on: [push, pull_request, workflow_dispatch, schedule]

jobs:
  # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #2: –í—Å—ë –≤ –æ–¥–Ω–æ–π –¥–∂–æ–±–µ
  do-everything:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #3: –•–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤
      - name: Setup
        run: |
          echo "DATABASE_URL=postgresql://admin:password123@prod-db.example.com/maindb" >> $GITHUB_ENV
          echo "API_KEY=sk-1234567890abcdef" >> $GITHUB_ENV
          export AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
          export AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #4: –ù–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è actions
      - uses: actions/setup-python@latest

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–µ–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest flake8 black

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #6: –¢–µ—Å—Ç—ã? –ù–µ, –Ω–µ —Å–ª—ã—à–∞–ª–∏
      - name: "Tests"
        run: echo "Tests passed! üéâ"

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #7: –°–±–æ—Ä–∫–∞ –±–µ–∑ —Ç–µ–≥–æ–≤
      - name: Build Docker image
        run: docker build -t myapp .

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #8: Push –≤ latest
      - name: Push to registry
        run: |
          docker tag myapp myregistry/myapp:latest
          docker push myregistry/myapp:latest

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #9: –î–µ–ø–ª–æ–π –ø—Ä—è–º–æ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          ssh root@prod-server.com "docker pull myregistry/myapp:latest && docker restart myapp"

      # –ü–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ #10: –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
      - name: Celebrate
        run: echo "Deployed! What could possibly go wrong?"
